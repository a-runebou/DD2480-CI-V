import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;

public class CompileRunner {

    /**
     * Result object holding the outcome of a Maven compile run.
     */
    public static final class Result {
        public final int exitCode;          // Process exit code
        public final String outputMessage;  // Standard output from Maven
        public final String errorMessage;   // Error output from Maven

        public Result(int exitCode, String outputMessage, String errorMessage) {
            this.exitCode = exitCode;
            this.outputMessage = outputMessage;
            this.errorMessage = errorMessage;
        }
    }

    /**
     * Executes "./mvnw compile" in the given repository directory.
     *
     * @param repoDir directory containing the Maven project
     * @return Result containing exit code and process output
     */
    public static Result runMvnwCompile(File repoDir)
            throws IOException, InterruptedException {

        if (repoDir == null || !repoDir.isDirectory()) {
            throw new IllegalArgumentException("repoDir must be an existing directory");
        }

        // Create a process that runs the Maven compile
        ProcessBuilder pb = new ProcessBuilder("./mvnw", "compile");
        pb.directory(repoDir);

        Process process = pb.start();

        // Read standard output and error output from the process
        String outputMessage = readAll(process.getInputStream());
        String errorMessage = readAll(process.getErrorStream());

        int exitCode = process.waitFor();

        return new Result(exitCode, outputMessage, errorMessage);
    }

    /**
     * Reads all text from an InputStream and returns it as a String.
     */
    private static String readAll(java.io.InputStream inputStream) throws IOException {
        StringBuilder sb = new StringBuilder();

        // Wrap InputStream to read text line by line
        try (BufferedReader br =
                     new BufferedReader(new InputStreamReader(inputStream))) {

            String line;
            while ((line = br.readLine()) != null) {
                sb.append(line).append("\n");
            }
        }

        return sb.toString();
    }

    /**
     * Temporary main method for local testing without the CI server.
     */
    public static void main(String[] args) {
        // Replace with the path to a Maven repository to test locally
        File repo = new File("PATH/TO/YOUR/REPO");

        try {
            Result result = runMvnwCompile(repo);

            System.out.println("=== mvnw compile exit code: " + result.exitCode + " ===");
            System.out.println("----- STDOUT -----");
            System.out.print(result.outputMessage);

            System.out.println("----- STDERR -----");
            System.out.print(result.errorMessage);

            if (result.exitCode != 0) {
                System.out.println("Compilation failed");
            } else {
                System.out.println("Compilation succeeded.");
            }
        } catch (Exception error) {
            error.printStackTrace();
        }
    }
}
